<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RUBIK'S RACE - SHOP & ITEMS</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bg: #0b0b0d; --panel: #1a1a1d; --accent: #00fbff; 
            --gold: #ffd700; --warn: #ff003c; --battle: #ff8800; 
            --tile: 60px; --target-tile: 22px; --gap: 5px; 
        }
        body { 
            background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; 
            margin: 0; display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; overflow: hidden; touch-action: manipulation; 
        }
        .screen { display: none; width: 100%; max-width: 500px; padding: 15px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        .card { background: var(--panel); padding: 25px; border-radius: 20px; width: 100%; border: 1px solid #333; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-sub { background: #333; color: #ccc; font-size: 0.9rem; padding: 12px; }
        
        /* ìƒì  ë° ì•„ì´í…œ UI */
        .shop-item { background: #222; border: 1px solid #444; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .coin-display { color: var(--gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        .item-inventory { display: flex; gap: 10px; margin-top: 10px; width: 100%; justify-content: center; }
        .item-slot { background: #222; border: 1px solid var(--accent); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
        .item-slot.active { background: var(--accent); color: #000; }

        .game-layout { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .board-grid { display: grid; grid-template-columns: repeat(5, var(--tile)); gap: var(--gap); background: #111; padding: 10px; border-radius: 12px; position: relative; }
        .tile { width: var(--tile); height: var(--tile); border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .tile.selected { border: 3px solid white; transform: scale(1.1); z-index: 5; box-shadow: 0 0 15px white; }
        .target-box { display: grid; grid-template-columns: repeat(3, var(--target-tile)); gap: 3px; background: #000; padding: 5px; border-radius: 5px; border: 1px solid var(--accent); transition: transform 0.5s; }
        .target-tile { width: var(--target-tile); height: var(--target-tile); border-radius: 2px; }
        .center-guide { position: absolute; top: calc(var(--tile) + 13px); left: calc(var(--tile) + 13px); width: calc(var(--tile)*3 + 14px); height: calc(var(--tile)*3 + 14px); border: 2px dashed var(--accent); pointer-events: none; opacity: 0.5; }

        /* ìƒ‰ìƒ */
        .red { background: #FF003C; } .blue { background: #007BFF; } .green { background: #00FF6A; } 
        .yellow { background: #FFD700; } .orange { background: #FF8800; } .white { background: #FFFFFF; } .empty { background: #222; }

        @media (max-width: 400px) { :root { --tile: 50px; --target-tile: 18px; } }
    </style>
</head>
<body>

    <div id="authScreen" class="screen active">
        <div class="card">
            <h1 style="color:var(--accent)">RUBIK'S SHOP</h1>
            <input type="text" id="nickInput" style="width:100%; padding:12px; margin-bottom:10px; background:#111; color:white; border:1px solid #333;" placeholder="ë‹‰ë„¤ì„">
            <input type="email" id="email" style="width:100%; padding:12px; margin-bottom:10px; background:#111; color:white; border:1px solid #333;" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" style="width:100%; padding:12px; margin-bottom:20px; background:#111; color:white; border:1px solid #333;" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn" onclick="handleAuth('login')">ë¡œê·¸ì¸</button>
            <button class="btn" onclick="handleAuth('signup')" style="background:#333; color:white;">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--accent)">LOBBY</h2>
            <div class="coin-display">ğŸ’° ë³´ìœ  ì½”ì¸: <span id="coinText">0</span></div>
            <button id="soloBtn" class="btn" onclick="startSolo()">ì†”ë¡œ ë­í‚¹ì „ ì‹œì‘</button>
            <button class="btn" style="background:var(--gold); color:black;" onclick="showScreen('shopScreen')">ğŸ›’ ì•„ì´í…œ ìƒì </button>
            <button class="btn btn-sub" onclick="resetToLevel1()" style="margin-top:20px; color:var(--warn);">âš ï¸ ë ˆë²¨ 1ë¶€í„° ë‹¤ì‹œí•˜ê¸° (ì½”ì¸ ë…¸ê°€ë‹¤)</button>
            <button class="btn btn-sub" onclick="auth.signOut()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="shopScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--gold)">ITEM SHOP</h2>
            <div class="coin-display">My Coins: <span id="shopCoinText">0</span></div>
            
            <div class="shop-item">
                <div>
                    <strong>[ë§ì¹˜] ë¸”ë¡ ê¹¨ê¸°</strong><br>
                    <small style="color:#888;">ì¤‘ì•™ 1ì¹¸ì„ ë¬´ì¡°ê±´ ì •ë‹µì²˜ë¦¬ (500ì½”ì¸)</small>
                </div>
                <button onclick="buyItem('hammer', 500)" style="padding:10px; background:var(--accent); border:none; border-radius:5px;">êµ¬ë§¤</button>
            </div>

            <div class="shop-item">
                <div>
                    <strong>[ìì„] ìœ„ì¹˜ ë°”ê¾¸ê¸°</strong><br>
                    <small style="color:#888;">ì¸ì ‘í•˜ì§€ ì•Šì€ ë‘ ë¸”ë¡ êµì²´ (300ì½”ì¸)</small>
                </div>
                <button onclick="buyItem('swap', 300)" style="padding:10px; background:var(--accent); border:none; border-radius:5px;">êµ¬ë§¤</button>
            </div>

            <button class="btn btn-sub" onclick="showScreen('lobbyScreen')">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="game-layout">
            <div class="coin-display" style="margin:0;">ğŸ’° <span id="gameCoinText">0</span></div>
            <div class="game-header" style="display:flex; justify-content:space-between; width:100%; background:#111; padding:10px; border-radius:10px;">
                <div id="targetBoard" class="target-box"></div>
                <div style="text-align:right">
                    <div id="lvText" style="color:var(--accent)">LV 01</div>
                    <div id="timerText" style="font-size:1.5rem;">00:00</div>
                </div>
            </div>

            <div class="item-inventory">
                <div id="inv_hammer" class="item-slot" onclick="useItem('hammer')">ğŸ”¨ ë§ì¹˜ (0)</div>
                <div id="inv_swap" class="item-slot" onclick="useItem('swap')">ğŸ§² ìì„ (0)</div>
            </div>

            <div id="mainBoard" class="board-grid"><div class="center-guide"></div></div>
            <button id="startBtn" class="btn" onclick="startGame()">GAME START</button>
            <button onclick="quitGame()" style="color:#555; background:none; border:none; text-decoration:underline;">ê·¸ë§Œë‘ê¸°</button>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì • (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyBZZuQHXYsbbJA3L1L8-yFSfbw1w15p3NE",
            authDomain: "rubigs.firebaseapp.com",
            databaseURL: "https://rubigs-default-rtdb.firebaseio.com/",
            projectId: "rubigs",
            appId: "1:175818594996:web:2ec5f57abe5f5a20d3d5e1"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let currentUid = "", userData = { nickname: "", score: 0, coins: 0, items: { hammer: 0, swap: 0 }, level: 1 };
        let curLevel = 1, board = [], target = [], empty = {r:4, c:4};
        let isRunning = false, startTime = 0, timerInterval;
        let activeItem = null, selectedTile = null;

        const COLORS = ['red', 'blue', 'green', 'yellow', 'orange', 'white'];

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUid = user.uid;
                db.ref(`users/${user.uid}`).on('value', snap => {
                    userData = snap.val() || userData;
                    document.getElementById('coinText').innerText = userData.coins || 0;
                    document.getElementById('shopCoinText').innerText = userData.coins || 0;
                    document.getElementById('gameCoinText').innerText = userData.coins || 0;
                    document.getElementById('inv_hammer').innerText = `ğŸ”¨ ë§ì¹˜ (${userData.items?.hammer || 0})`;
                    document.getElementById('inv_swap').innerText = `ğŸ§² ìì„ (${userData.items?.swap || 0})`;
                    curLevel = userData.level || 1;
                    document.getElementById('soloBtn').innerText = `ğŸ† ì†”ë¡œ ë­í‚¹ì „ ì‹œì‘ (LV ${curLevel})`;
                });
                showScreen('lobbyScreen');
            } else { showScreen('authScreen'); }
        });

        function handleAuth(mode) {
            const email = document.getElementById('email').value, pw = document.getElementById('password').value, nick = document.getElementById('nickInput').value;
            if(mode === 'signup') {
                auth.createUserWithEmailAndPassword(email, pw).then(res => 
                    db.ref(`users/${res.user.uid}`).set({nickname: nick, score: 0, coins: 100, level: 1, items: {hammer:0, swap:0}})
                ).catch(e=>alert(e.message));
            } else { auth.signInWithEmailAndPassword(email, pw).catch(e=>alert(e.message)); }
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        // ìƒì  ê¸°ëŠ¥
        function buyItem(item, price) {
            if(userData.coins < price) return alert("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            db.ref(`users/${currentUid}`).update({
                coins: userData.coins - price,
                [`items/${item}`]: (userData.items?.[item] || 0) + 1
            });
            alert("êµ¬ë§¤ ì™„ë£Œ!");
        }

        function resetToLevel1() {
            if(confirm("ì •ë§ë¡œ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì½”ì¸ ìˆ˜ê¸‰ìš©)")) {
                db.ref(`users/${currentUid}`).update({ level: 1 });
            }
        }

        // ê²Œì„ ë¡œì§
        function startSolo() { showScreen('gameScreen'); resetEngine(); }
        function resetEngine() {
            document.getElementById('startBtn').style.display = "block";
            document.getElementById('mainBoard').innerHTML = '<div class="center-guide"></div>';
            document.getElementById('targetBoard').innerHTML = '';
        }

        function startGame() {
            isRunning = true; startTime = Date.now();
            document.getElementById('startBtn').style.display = "none";
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timerText').innerText = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
            }, 1000);
            initLevel();
        }

        function initLevel() {
            // ë³´ë“œ ì´ˆê¸°í™”
            let p = []; COLORS.forEach(c => { for(let i=0; i<4; i++) p.push(c); }); p.push(COLORS[0]); p.sort(() => Math.random() - 0.5);
            board = []; let idx = 0;
            for(let r=0; r<5; r++) {
                let row = [];
                for(let c=0; c<5; c++) {
                    if(r===4 && c===4) { row.push('empty'); empty = {r:4, c:4}; }
                    else { row.push(p[idx++]); }
                }
                board.push(row);
            }
            // íƒ€ê²Ÿ ì´ˆê¸°í™”
            let tp = []; COLORS.forEach(c => { for(let i=0; i<4; i++) tp.push(c); }); tp.sort(() => Math.random() - 0.5);
            target = []; for(let r=0; r<3; r++) { let row = []; for(let c=0; c<3; c++) row.push(tp.pop()); target.push(row); }
            render();
        }

        function render() {
            const mb = document.getElementById('mainBoard'); mb.innerHTML = '<div class="center-guide"></div>';
            board.forEach((row, r) => { row.forEach((col, c) => {
                const d = document.createElement('div');
                d.className = `tile ${col} ${selectedTile?.r === r && selectedTile?.c === c ? 'selected' : ''}`;
                d.onclick = () => handleTileClick(r, c);
                mb.appendChild(d);
            }); });
            const tb = document.getElementById('targetBoard'); tb.innerHTML = '';
            target.forEach((row, r) => { row.forEach((col, c) => {
                const d = document.createElement('div');
                // ë§ì¹˜ ì•„ì´í…œ íš¨ê³¼ (ê°€ìš´ë° í•œ ì¹¸ ë¹„ìš°ê¸°)
                if(activeItem === 'hammer_active' && r === 1 && c === 1) d.className = 'target-tile empty';
                else d.className = `target-tile ${col}`;
                tb.appendChild(d);
            }); });
            document.getElementById('lvText').innerText = `LV ${curLevel}`;
        }

        function handleTileClick(r, c) {
            if(!isRunning) return;
            if(activeItem === 'swap') {
                if(!selectedTile) {
                    selectedTile = {r, c}; render();
                } else {
                    const temp = board[r][c];
                    board[r][c] = board[selectedTile.r][selectedTile.c];
                    board[selectedTile.r][selectedTile.c] = temp;
                    if(board[r][c] === 'empty') empty = {r, c};
                    if(board[selectedTile.r][selectedTile.c] === 'empty') empty = {r: selectedTile.r, c: selectedTile.c};
                    useItemConfirm('swap');
                    selectedTile = null; activeItem = null; render(); checkWin();
                }
            } else {
                if(Math.abs(r - empty.r) + Math.abs(c - empty.c) !== 1) return;
                board[empty.r][empty.c] = board[r][c]; board[r][c] = 'empty'; empty = {r, c};
                render(); checkWin();
            }
        }

        // ì•„ì´í…œ ì‚¬ìš©
        function useItem(type) {
            if(!isRunning) return;
            if((userData.items?.[type] || 0) <= 0) return alert("ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤!");
            
            if(type === 'hammer') {
                if(confirm("ë§ì¹˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ì•™ 1ì¹¸ì„ ë¬´íš¨í™”í• ê¹Œìš”?")) {
                    activeItem = 'hammer_active';
                    useItemConfirm('hammer');
                    render(); checkWin();
                }
            } else if(type === 'swap') {
                alert("ë°”ê¿€ ë‘ ë¸”ë¡ì„ ì°¨ë¡€ëŒ€ë¡œ ì„ íƒí•˜ì„¸ìš”.");
                activeItem = 'swap';
            }
        }

        function useItemConfirm(type) {
            db.ref(`users/${currentUid}/items/${type}`).set(userData.items[type] - 1);
        }

        function checkWin() {
            let match = true;
            for(let r=0; r<3; r++) {
                for(let c=0; c<3; c++) {
                    if(activeItem === 'hammer_active' && r === 1 && c === 1) continue;
                    if(board[r+1][c+1] !== target[r][c]) { match = false; break; }
                }
            }
            if(match) {
                isRunning = false; clearInterval(timerInterval);
                const reward = curLevel * 20 + 50; // ë ˆë²¨ë³„ ë³´ìƒ ê³µì‹
                alert(`ğŸ‰ LV ${curLevel} í´ë¦¬ì–´!\në³´ìƒ: ${reward} ì½”ì¸`);
                db.ref(`users/${currentUid}`).update({
                    level: curLevel + 1,
                    coins: userData.coins + reward
                });
                resetEngine();
            }
        }

        function quitGame() { isRunning = false; clearInterval(timerInterval); showScreen('lobbyScreen'); }

    </script>
</body>
</html>
